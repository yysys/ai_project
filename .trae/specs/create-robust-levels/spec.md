# 创建稳健的关卡系统 Spec

## Why
当前关卡生成器和求解器容易陷入死循环，且生成的关卡无法保证100%可通关。需要设计10个从易到难的高质量关卡，确保每个关卡都能稳定生成且必定可解，为玩家提供良好的游戏体验。

## What Changes
- **优化关卡生成器**：添加超时机制和重试策略，防止死循环
- **增强关卡求解器**：添加超时检测和资源限制，避免无限递归
- **设计10个递进难度关卡**：从第1关（简单）到第10关（困难），确保难度曲线平滑
- **实现关卡验证系统**：每个关卡生成后必须通过可解性验证
- **添加关卡测试流程**：自动化测试确保100%通关率

## Impact
- Affected specs: 关卡生成系统、关卡验证系统、游戏难度曲线
- Affected code: 
  - `simulation/src/PuzzleGenerator.cpp` - 关卡生成逻辑
  - `simulation/src/PuzzleSolver.cpp` - 关卡求解逻辑
  - `simulation/src/main.cpp` - 主程序入口
  - `simulation_json/level_*.json` - 关卡配置文件

## ADDED Requirements

### Requirement: 防死循环的关卡生成器
系统应当提供具备超时机制的关卡生成功能。

#### Scenario: 生成关卡时防止死循环
- **WHEN** 调用 `generateSolvableLevel()` 生成关卡
- **THEN** 系统在指定时间内（默认30秒）必须返回结果
- **AND** 如果超时则返回失败状态而非无限等待
- **AND** 每次重试都有独立的超时检测

#### Scenario: 关卡生成失败时的降级策略
- **WHEN** 关卡生成超过最大重试次数（默认50次）
- **THEN** 系统降低难度参数后继续尝试
- **AND** 记录失败日志供后续分析
- **AND** 最终返回一个简化但保证可解的关卡

### Requirement: 防死循环的关卡求解器
系统应当提供具备资源限制的关卡验证功能。

#### Scenario: 验证关卡时防止死循环
- **WHEN** 调用 `isSolvable()` 验证关卡可解性
- **THEN** 系统限制最大递归深度（默认1000层）
- **AND** 系统限制最大状态数量（默认100000个）
- **AND** 超过限制时返回"未知"状态而非崩溃

#### Scenario: 求解超时处理
- **WHEN** BFS/DFS算法执行超过设定时间（默认10秒）
- **THEN** 系统终止当前搜索
- **AND** 返回"求解超时"状态
- **AND** 建议降低关卡复杂度

### Requirement: 10个递进难度关卡
系统应当提供10个难度递增的关卡配置。

#### Scenario: 关卡难度配置
- **WHEN** 加载关卡1-3（简单）
- **THEN** 有效网格大小为6x6
- **AND** 最大方块尺寸为2格
- **AND** 方块密度为40-50%
- **AND** 最少移动步数为2-4步

#### Scenario: 关卡难度配置
- **WHEN** 加载关卡4-6（中等）
- **THEN** 有效网格大小为8x8
- **AND** 最大方块尺寸为2格
- **AND** 方块密度为50-60%
- **AND** 最少移动步数为4-8步

#### Scenario: 关卡难度配置
- **WHEN** 加载关卡7-10（困难）
- **THEN** 有效网格大小为10x10
- **AND** 最大方块尺寸为3格
- **AND** 方块密度为60-70%
- **AND** 最少移动步数为8-15步

### Requirement: 关卡100%可通关保证
系统应当确保每个生成的关卡都经过验证。

#### Scenario: 关卡生成后自动验证
- **WHEN** 生成新关卡
- **THEN** 系统自动运行求解器验证可解性
- **AND** 只有验证通过的关卡才会保存
- **AND** 验证失败则重新生成

#### Scenario: 批量关卡生成
- **WHEN** 批量生成10个关卡
- **THEN** 每个关卡独立验证
- **AND** 失败的关卡自动重试生成
- **AND** 最终输出10个全部可解的关卡

### Requirement: 关卡生成进度报告
系统应当提供详细的关卡生成和验证报告。

#### Scenario: 生成进度输出
- **WHEN** 执行关卡生成程序
- **THEN** 实时显示当前正在生成的关卡编号
- **AND** 显示每个关卡的重试次数
- **AND** 显示验证耗时
- **AND** 最终生成汇总报告

## MODIFIED Requirements

### Requirement: PuzzleGenerator::generateSolvableLevel()
增强现有的关卡生成方法，添加超时和重试机制。

**修改内容**：
- 添加总超时限制（30秒）
- 优化重试策略（智能降低难度）
- 添加进度回调支持
- 改进日志输出

### Requirement: PuzzleSolver::solveDFS()
增强DFS求解器，添加资源监控。

**修改内容**：
- 添加执行时间监控
- 优化状态哈希算法
- 添加内存使用估算
- 支持提前终止

### Requirement: PuzzleSolver::solveBFS()
增强BFS求解器，添加超时检测。

**修改内容**：
- 添加执行时间限制
- 优化队列管理
- 添加内存使用限制
- 支持渐进式求解

## REMOVED Requirements

### Requirement: 无限重试机制
**Reason**: 可能导致程序无限运行
**Migration**: 替换为有超时限制的重试策略
